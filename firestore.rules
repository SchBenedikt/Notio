rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserSettings() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)/settings/main);
    }
    
    function userHasSchool() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)/settings/main) 
        && 'schoolId' in getUserSettings().data && getUserSettings().data.schoolId != '';
    }
    
    function isValidPostCreate() {
      let data = request.resource.data;
      let coreValid = isOwner(data.authorId) &&
             data.authorName == request.auth.token.name &&
             data.content is string && data.content.size() <= 1000 &&
             data.likes == [] &&
             data.commentCount == 0 &&
             data.createdAt == request.time;
      let attachmentsValid = !('attachments' in data) || (
          data.attachments is list &&
          data.attachments.size() <= 5 &&
          (data.attachments.size() == 0 ||
           (data.attachments[0].name is string && data.attachments[0].dataUrl is string)
          )
      );
      let hasContent = data.content.size() > 0 || ( 'attachments' in data && data.attachments.size() > 0);
      return coreValid && attachmentsValid && hasContent;
    }

    function isValidCommentCreate() {
      let data = request.resource.data;
      return isOwner(data.authorId) &&
             data.authorName == request.auth.token.name &&
             data.content is string &&
             data.content.size() > 0 && data.content.size() <= 1000 &&
             data.createdAt == request.time;
    }

    function isLiking() {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
    }

    function isEditingContent() {
        return isOwner(resource.data.authorId) &&
               request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content']);
    }

    function isIncrementingCommentCount() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']) &&
               request.resource.data.commentCount == resource.data.commentCount + 1;
    }

    function isDecrementingCommentCount() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']) &&
               request.resource.data.commentCount == resource.data.commentCount - 1;
    }

    function isEditingCommentContent() {
      return isOwner(resource.data.authorId) &&
             request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content']);
    }

    // --- Private User Data ---
    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }

    // --- Public Profiles ---
    match /profiles/{userId} {
      allow read: if isSignedIn();
      allow create, delete: if isOwner(userId);
      allow update: if isOwner(userId) || 
                     (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followers']));
    }
    
    // Explicit rule for study sets - this is covered by the general user data rule, but can be kept for clarity
    match /users/{userId}/studySets/{studySetId} {
      allow read, write: if isOwner(userId);
    }

    // --- Schools ---
    match /schools/{schoolId} {
      allow read, create: if request.auth != null;
      allow update, delete: if false;
    }

    // --- School Events ---
    match /schoolEvents/{eventId} {
      // Anyone signed in can create an event, as long as they assign it to their own school.
      allow create: if isSignedIn() && request.resource.data.schoolId == getUserSettings().data.schoolId;
      
      // Allow reading events if the user belongs to that school.
      // The client query MUST filter by schoolId for this to work.
      allow read: if isSignedIn() && userHasSchool() && getUserSettings().data.schoolId == resource.data.schoolId;
      
      // Only the author of an event can update or delete it.
      allow update, delete: if isSignedIn() && isOwner(resource.data.authorId);
    }

    // --- Community Posts & Comments ---
    match /posts/{postId} {
      allow read: if isSignedIn();
      allow delete: if isOwner(resource.data.authorId);
      allow create: if isSignedIn() && isValidPostCreate();
      allow update: if isEditingContent() || isLiking() || isIncrementingCommentCount() || isDecrementingCommentCount();

      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow delete: if isOwner(resource.data.authorId);
        allow create: if isSignedIn() && isValidCommentCreate();
        allow update: if isSignedIn() && isEditingCommentContent();
      }
    }
  }
}
