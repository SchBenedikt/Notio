rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserSchoolId() {
      // Safely get the user's schoolId from their settings document.
      // Returns null if the document or field doesn't exist.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)/settings/main).data.schoolId;
    }

    function isValidPostCreate() {
      let data = request.resource.data;
      let coreValid = isOwner(data.authorId) &&
             data.authorName == request.auth.token.name &&
             data.content is string && data.content.size() <= 1000 &&
             data.likes == [] &&
             data.commentCount == 0 &&
             data.createdAt == request.time;
      let attachmentsValid = !('attachments' in data) || (
          data.attachments is list &&
          data.attachments.size() <= 5 &&
          (data.attachments.size() == 0 ||
           (data.attachments[0].name is string && data.attachments[0].dataUrl is string)
          )
      );
      let hasContent = data.content.size() > 0 || ( 'attachments' in data && data.attachments.size() > 0);
      return coreValid && attachmentsValid && hasContent;
    }

    function isValidCommentCreate() {
      let data = request.resource.data;
      return isOwner(data.authorId) &&
             data.authorName == request.auth.token.name &&
             data.content is string &&
             data.content.size() > 0 && data.content.size() <= 1000 &&
             data.createdAt == request.time;
    }

    function isLiking() {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
    }

    function isEditingContent() {
        return isOwner(resource.data.authorId) &&
               request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content']);
    }

    function isIncrementingCommentCount() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']) &&
               request.resource.data.commentCount == resource.data.commentCount + 1;
    }
    
    function isDecrementingCommentCount() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']) &&
               request.resource.data.commentCount == resource.data.commentCount - 1;
    }
    
    function isEditingCommentContent() {
      return isOwner(resource.data.authorId) &&
             request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content']);
    }


    // --- Private User Data ---
    // Includes subjects, grades, study sets, settings.
    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }

    // --- Public Profiles ---
    match /profiles/{userId} {
      allow read: if isSignedIn();
      allow create, delete: if isOwner(userId);
      // Allow user to update their own profile, or other users to update the followers list.
      allow update: if isOwner(userId) || 
                     (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followers']));
    }
    
    // --- Schools List ---
    match /schools/{schoolId} {
      allow read, create: if isSignedIn();
      // Prevent accidental deletion/modification of school entries by users.
      allow update, delete: if false; 
    }

    // --- Shared School Calendar Events ---
    match /schoolEvents/{eventId} {
      // A user can read an event if they are signed in AND the event's schoolId
      // matches the schoolId stored in that user's settings document.
      allow read: if isSignedIn() && getUserSchoolId() == resource.data.schoolId;
      
      // A user can create an event if they are the author and the event is for their own school.
      allow create: if isSignedIn() &&
                       request.resource.data.authorId == request.auth.uid &&
                       request.resource.data.schoolId == getUserSchoolId();
                       
      // Only the original author can update or delete their event.
      allow update, delete: if isSignedIn() && isOwner(resource.data.authorId);
    }

    // --- Community Posts & Comments ---
    match /posts/{postId} {
      allow read: if isSignedIn();
      allow delete: if isOwner(resource.data.authorId);
      allow create: if isSignedIn() && isValidPostCreate();
      allow update: if isEditingContent() || isLiking() || isIncrementingCommentCount() || isDecrementingCommentCount();

      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow delete: if isOwner(resource.data.authorId);
        allow create: if isSignedIn() && isValidCommentCreate();
        allow update: if isSignedIn() && isEditingCommentContent();
      }
    }
  }
}