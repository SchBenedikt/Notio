
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    function isSignedIn() {
      return request.auth != null;
    }
    // Function to get user's settings document data safely
    function getUserSettings() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)/settings/main).data;
    }
    function isValidPostCreate() {
      let data = request.resource.data;
      // Validate core fields
      let coreValid = isOwner(data.authorId) &&
             data.authorName == request.auth.token.name &&
             data.content is string && data.content.size() <= 1000 &&
             data.likes == [] &&
             data.commentCount == 0 &&
             data.createdAt == request.time;
    
      // Validate attachments if they exist
      let attachmentsValid = !('attachments' in data) || (
          data.attachments is list &&
          data.attachments.size() <= 5 &&
          (data.attachments.size() == 0 ||
           (data.attachments[0].name is string && data.attachments[0].dataUrl is string)
          )
      );

      // A post must have either content or an attachment
      let hasContent = data.content.size() > 0 || ( 'attachments' in data && data.attachments.size() > 0);
      
      return coreValid && attachmentsValid && hasContent;
    }
    function isValidCommentCreate() {
      let data = request.resource.data;
      return isOwner(data.authorId) &&
             data.authorName == request.auth.token.name &&
             data.content is string &&
             data.content.size() > 0 && data.content.size() <= 1000 &&
             data.createdAt == request.time;
    }
    function isLiking() {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
    }
    function isEditingContent() {
        return isOwner(resource.data.authorId) &&
               request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content']);
    }
    function isIncrementingCommentCount() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']) &&
               request.resource.data.commentCount == resource.data.commentCount + 1;
    }
    function isDecrementingCommentCount() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']) &&
               request.resource.data.commentCount == resource.data.commentCount - 1;
    }
    function isEditingCommentContent() {
      return isOwner(resource.data.authorId) &&
             request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content']);
    }

    // --- Private User Data ---
    // Users can read/write their own data (subjects, grades, settings, study sets)
    match /users/{userId}/{path=**} {
      allow read, write: if isOwner(userId);
    }

    // --- Public Profiles ---
    match /profiles/{userId} {
      allow read: if isSignedIn();
      allow create, delete: if isOwner(userId);
      allow update: if isOwner(userId) || 
                     (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followers']));
    }

    // --- Schools ---
    // Any signed-in user can read the list of schools and create a new one
    match /schools/{schoolId} {
      allow read, create: if isSignedIn();
      allow update, delete: if false; // Only admins should do this, rule set to false for now
    }
    
    // --- Shared School Events ---
    match /schoolEvents/{eventId} {
      // Any signed in user with a school can create an event
      allow create: if isSignedIn() && getUserSettings().schoolId != null;
      
      // A user can read an event if their schoolId matches the event's schoolId.
      // This rule works for both single 'get' and collection 'list' queries,
      // as long as the list query filters by 'schoolId'.
      allow read: if isSignedIn() && getUserSettings().schoolId == resource.data.schoolId;
      
      // Only the author of an event can update or delete it.
      allow update, delete: if isSignedIn() && isOwner(resource.data.authorId);
    }

    // --- Community Posts & Comments ---
    match /posts/{postId} {
      allow read: if isSignedIn();
      allow delete: if isOwner(resource.data.authorId);
      allow create: if isSignedIn() && isValidPostCreate();
      allow update: if isEditingContent() || isLiking() || isIncrementingCommentCount() || isDecrementingCommentCount();

      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow delete: if isOwner(resource.data.authorId);
        allow create: if isSignedIn() && isValidCommentCreate();
        allow update: if isSignedIn() && isEditingCommentContent();
      }
    }
  }
}
